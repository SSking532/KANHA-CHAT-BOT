<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KANHA - Chat</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="light-theme">

  <div id="chatScreen">

    <div id="chatHeader">
      <img src="images/logo.jpg" alt="KANHA Logo" class="logo-small"/>
      <h2>KANHA - Your Travel Companion</h2>
      <button id="themeToggle" title="Toggle Light/Dark Theme">ðŸŒ™</button>
    </div>

    <div id="messages"></div>

    <div id="controls">
      <select id="languageSelect">
        <option value="en-US">English</option>
    <option value="hi-IN">Hindi</option>
    <option value="bn-IN">Bengali</option>
    <option value="pa-IN">Punjabi</option>
    <option value="ta-IN">Tamil</option>
    <option value="te-IN">Telugu</option>
    <option value="mr-IN">Marathi</option>
    <option value="ml-IN">Malayalam</option>
    <option value="gu-IN">Gujarati</option>
    <option value="ne-NP">Nepali</option>
    <option value="fr-FR">French</option>
    <option value="es-ES">Spanish</option>
    <option value="it-IT">Italian</option>
    <option value="ur-PK">Urdu</option>
    <option value="as-IN">Assamese</option>
    <option value="mni-IN">Manipuri</option>
    <option value="zh-CN">Chinese</option>


        <!-- Add other languages -->
      </select>

      <select id="genderSelect">
        <option value="female">Female Voice</option>
        <option value="male">Male Voice</option>
      </select>

      <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off"/>
      <button onclick="sendMessage()">Send</button>
    </div>

  </div>

  <script>
    const userAvatarUrl = "images/usericon.png";
    const botAvatarUrl = "images/boticon.png";

    let voices = [];
    window.speechSynthesis.onvoiceschanged = () => {
      voices = window.speechSynthesis.getVoices();
    };

    // Theme toggle
    const themeToggleBtn = document.getElementById("themeToggle");
    const bodyEl = document.body;
    themeToggleBtn.onclick = () => {
      if (bodyEl.classList.contains("light-theme")) {
        bodyEl.classList.remove("light-theme");
        bodyEl.classList.add("dark-theme");
        themeToggleBtn.textContent = "â˜€ï¸";
      } else {
        bodyEl.classList.remove("dark-theme");
        bodyEl.classList.add("light-theme");
        themeToggleBtn.textContent = "ðŸŒ™";
      }
    };

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const msg = input.value.trim();
      if (!msg) return;

      const messagesDiv = document.getElementById("messages");

      // User message + avatar
      const userMsgDiv = document.createElement("div");
      userMsgDiv.className = "message user";

      const ua = document.createElement("img");
      ua.src = userAvatarUrl;
      ua.alt = "User";
      ua.className = "avatar";

      const ut = document.createElement("div");
      ut.className = "text";
      ut.textContent = msg;

      userMsgDiv.appendChild(ua);
      userMsgDiv.appendChild(ut);
      messagesDiv.appendChild(userMsgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      input.value = "";
      input.disabled = true;

      try {
        const resp = await fetch("http://127.0.0.1:5000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: msg,
            language: document.getElementById("languageSelect").value,
            gender: document.getElementById("genderSelect").value
          })
        });
        const data = await resp.json();

        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "message bot";

        const ba = document.createElement("img");
        ba.src = botAvatarUrl;
        ba.alt = "Bot";
        ba.className = "avatar";

        const bt = document.createElement("div");
        bt.className = "text";
        bt.innerHTML = data.reply;  // HTML content (table etc)

        botMsgDiv.appendChild(ba);
        botMsgDiv.appendChild(bt);
        messagesDiv.appendChild(botMsgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // speak
        let utterance = new SpeechSynthesisUtterance(data.plain_reply || data.reply);
        if (data.gender === "female") {
          utterance.voice = voices.find(v => v.name.toLowerCase().includes("female")) || voices[0];
        } else {
          utterance.voice = voices.find(v => v.name.toLowerCase().includes("male")) || voices[0];
        }
        utterance.pitch = 1.4;
        utterance.rate = 1;
        utterance.lang = data.language;

        window.speechSynthesis.speak(utterance);

      } catch (err) {
        console.error("Error:", err);
        const errorDiv = document.createElement("div");
        errorDiv.className = "message bot";
        errorDiv.innerText = "Oops! Something went wrong.";
        messagesDiv.appendChild(errorDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    document.getElementById("userInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") sendMessage();
    });

  </script>

</body>
</html>
